{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["// middleware.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport { jwtVerify } from \"jose\";\r\n\r\n// имя cookie ДОЛЖНО совпадать с тем, что ты ставишь в /api/session/sync\r\nconst COOKIE_NAME = \"authToken\";\r\n\r\n// один и тот же секрет, что и при подписи токена\r\nconst SECRET = new TextEncoder().encode(\r\n  process.env.JWT_SECRET || \"dev_secret_fallback\"\r\n);\r\n\r\nexport async function middleware(req: NextRequest) {\r\n  try {\r\n    const { pathname, search } = req.nextUrl;\r\n\r\n    // Защищаем только /admin — всё остальное пропускаем\r\n    if (!pathname.startsWith(\"/admin\")) return NextResponse.next();\r\n\r\n    const token = req.cookies.get(COOKIE_NAME)?.value;\r\n    if (!token) {\r\n      const signin = new URL(\"/signin\", req.url);\r\n      signin.searchParams.set(\"next\", pathname + search);\r\n      return NextResponse.redirect(signin);\r\n    }\r\n\r\n    // Edge-совместимая проверка JWT\r\n    const { payload } = await jwtVerify(token, SECRET, {\r\n      algorithms: [\"HS256\"],\r\n    });\r\n    const role = ((payload as any)?.role ||\r\n      (Array.isArray((payload as any)?.roles) && (payload as any).roles[0]) ||\r\n      (Array.isArray((payload as any)?.authorities) &&\r\n        (payload as any).authorities[0]) ||\r\n      \"\") as string;\r\n\r\n    if ((role || \"\").toLowerCase() !== \"admin\") {\r\n      const signin = new URL(\"/signin\", req.url);\r\n      signin.searchParams.set(\"next\", pathname + search);\r\n      return NextResponse.redirect(signin);\r\n    }\r\n\r\n    return NextResponse.next();\r\n  } catch {\r\n    // Любая ошибка в middleware — просто уводим на signin для /admin\r\n    // и НИКОГДА не ломаем остальные страницы\r\n    const signin = new URL(\"/signin\", req.url);\r\n    signin.searchParams.set(\"next\", req.nextUrl.pathname + req.nextUrl.search);\r\n    if (!req.nextUrl.pathname.startsWith(\"/admin\")) return NextResponse.next();\r\n    return NextResponse.redirect(signin);\r\n  }\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/admin/:path*\"], // middleware активен только под /admin\r\n};\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;;;AAChB;AAAA;AAEA;;;AAEA,wEAAwE;AACxE,MAAM,cAAc;AAEpB,iDAAiD;AACjD,MAAM,SAAS,IAAI,cAAc,MAAM,CACrC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAGrB,eAAe,WAAW,GAAgB;IAC/C,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,IAAI,OAAO;QAExC,oDAAoD;QACpD,IAAI,CAAC,SAAS,UAAU,CAAC,WAAW,OAAO,gMAAY,CAAC,IAAI;QAE5D,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;QAC5C,IAAI,CAAC,OAAO;YACV,MAAM,SAAS,IAAI,IAAI,WAAW,IAAI,GAAG;YACzC,OAAO,YAAY,CAAC,GAAG,CAAC,QAAQ,WAAW;YAC3C,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;QAEA,gCAAgC;QAChC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4KAAS,EAAC,OAAO,QAAQ;YACjD,YAAY;gBAAC;aAAQ;QACvB;QACA,MAAM,OAAQ,AAAC,SAAiB,QAC7B,MAAM,OAAO,CAAE,SAAiB,UAAU,AAAC,QAAgB,KAAK,CAAC,EAAE,IACnE,MAAM,OAAO,CAAE,SAAiB,gBAC/B,AAAC,QAAgB,WAAW,CAAC,EAAE,IACjC;QAEF,IAAI,CAAC,QAAQ,EAAE,EAAE,WAAW,OAAO,SAAS;YAC1C,MAAM,SAAS,IAAI,IAAI,WAAW,IAAI,GAAG;YACzC,OAAO,YAAY,CAAC,GAAG,CAAC,QAAQ,WAAW;YAC3C,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;QAEA,OAAO,gMAAY,CAAC,IAAI;IAC1B,EAAE,OAAM;QACN,iEAAiE;QACjE,yCAAyC;QACzC,MAAM,SAAS,IAAI,IAAI,WAAW,IAAI,GAAG;QACzC,OAAO,YAAY,CAAC,GAAG,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,GAAG,IAAI,OAAO,CAAC,MAAM;QACzE,IAAI,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,WAAW,OAAO,gMAAY,CAAC,IAAI;QACxE,OAAO,gMAAY,CAAC,QAAQ,CAAC;IAC/B;AACF;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAgB;AAC5B"}}]
}