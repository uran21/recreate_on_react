{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prismaGlobal: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prismaGlobal ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prismaGlobal = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,OAAO,YAAY,IACnB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,OAAO,YAAY,GAAG","debugId":null}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/server/jwt.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"dev_secret_fallback\";\r\n\r\nexport type JwtPayload = { id: number; login: string; role: string };\r\n\r\nexport function signJwt(payload: JwtPayload, days = 7) {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: `${days}d` });\r\n}\r\n\r\nexport function verifyJwt(token: string): JwtPayload | null {\r\n  try { return jwt.verify(token, JWT_SECRET) as JwtPayload; }\r\n  catch { return null; }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAItC,SAAS,QAAQ,OAAmB,EAAE,OAAO,CAAC;IACnD,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW,GAAG,KAAK,CAAC,CAAC;IAAC;AAC/D;AAEO,SAAS,UAAU,KAAa;IACrC,IAAI;QAAE,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAA2B,EAC1D,OAAM;QAAE,OAAO;IAAM;AACvB","debugId":null}},
    {"offset": {"line": 119, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/app/api/admin/analytics/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { verifyJwt } from \"@/server/jwt\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\ntype TopProductOut = {\r\n  category: string;\r\n  name: string;\r\n  qty: number;\r\n  revenueCents: number;\r\n};\r\n\r\nexport async function GET(req: Request) {\r\n  const token = (req.headers.get(\"authorization\") || \"\").replace(\r\n    /^Bearer\\s+/i,\r\n    \"\"\r\n  );\r\n  const me = verifyJwt(token);\r\n  if (!me) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n  if ((me.role || \"\").toLowerCase() !== \"admin\") {\r\n    return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n  }\r\n\r\n  const url = new URL(req.url);\r\n  const days = Math.max(\r\n    1,\r\n    Math.min(365, Number(url.searchParams.get(\"days\")) || 30)\r\n  ); // 1..365\r\n  const perCategory = Math.max(\r\n    1,\r\n    Math.min(50, Number(url.searchParams.get(\"limit\")) || 5)\r\n  ); // топ-N в категории\r\n  const since = new Date(Date.now() - days * 24 * 3600 * 1000);\r\n\r\n  // Берём заказы за период с их позициями и продуктами\r\n  const orders = await prisma.order.findMany({\r\n    where: { createdAt: { gte: since } },\r\n    select: {\r\n      items: {\r\n        select: {\r\n          quantity: true,\r\n          unitCents: true,\r\n          product: { select: { name: true, category: true } },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  // Аггрегируем в памяти: ключ = category|name\r\n  const map = new Map<string, TopProductOut>();\r\n  for (const o of orders) {\r\n    for (const it of o.items) {\r\n      const name = it.product?.name ?? \"Unnamed\";\r\n      const category = it.product?.category ?? \"Other\";\r\n      const key = `${category}|||${name}`;\r\n      const prev = map.get(key) || { category, name, qty: 0, revenueCents: 0 };\r\n      prev.qty += Number(it.quantity || 0);\r\n      prev.revenueCents += Number(it.unitCents || 0) * Number(it.quantity || 0);\r\n      map.set(key, prev);\r\n    }\r\n  }\r\n\r\n  // Группируем по категории -> сортируем -> берём топ-N\r\n  const byCat = new Map<string, TopProductOut[]>();\r\n  for (const item of map.values()) {\r\n    const cat = item.category || \"Other\";\r\n    if (!byCat.has(cat)) byCat.set(cat, []);\r\n    byCat.get(cat)!.push(item);\r\n  }\r\n  for (const [cat, arr] of byCat.entries()) {\r\n    arr.sort((a, b) => b.revenueCents - a.revenueCents || b.qty - a.qty);\r\n    byCat.set(cat, arr.slice(0, perCategory));\r\n  }\r\n\r\n  // В один плоский список (если на клиенте уже группируете — можно отправлять мапу)\r\n  const topProducts: TopProductOut[] = [];\r\n  for (const arr of byCat.values()) topProducts.push(...arr);\r\n\r\n  return NextResponse.json({\r\n    data: { topProducts },\r\n    message: \"OK\",\r\n    error: null,\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAShB,eAAe,IAAI,GAAY;IACpC,MAAM,QAAQ,CAAC,IAAI,OAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,EAAE,OAAO,CAC5D,eACA;IAEF,MAAM,KAAK,IAAA,mIAAS,EAAC;IACrB,IAAI,CAAC,IAAI,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IAC3E,IAAI,CAAC,GAAG,IAAI,IAAI,EAAE,EAAE,WAAW,OAAO,SAAS;QAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IAEA,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,OAAO,KAAK,GAAG,CACnB,GACA,KAAK,GAAG,CAAC,KAAK,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY,MACrD,SAAS;IACZ,MAAM,cAAc,KAAK,GAAG,CAC1B,GACA,KAAK,GAAG,CAAC,IAAI,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,aAAa,KACrD,oBAAoB;IACvB,MAAM,QAAQ,IAAI,KAAK,KAAK,GAAG,KAAK,OAAO,KAAK,OAAO;IAEvD,qDAAqD;IACrD,MAAM,SAAS,MAAM,gIAAM,CAAC,KAAK,CAAC,QAAQ,CAAC;QACzC,OAAO;YAAE,WAAW;gBAAE,KAAK;YAAM;QAAE;QACnC,QAAQ;YACN,OAAO;gBACL,QAAQ;oBACN,UAAU;oBACV,WAAW;oBACX,SAAS;wBAAE,QAAQ;4BAAE,MAAM;4BAAM,UAAU;wBAAK;oBAAE;gBACpD;YACF;QACF;IACF;IAEA,6CAA6C;IAC7C,MAAM,MAAM,IAAI;IAChB,KAAK,MAAM,KAAK,OAAQ;QACtB,KAAK,MAAM,MAAM,EAAE,KAAK,CAAE;YACxB,MAAM,OAAO,GAAG,OAAO,EAAE,QAAQ;YACjC,MAAM,WAAW,GAAG,OAAO,EAAE,YAAY;YACzC,MAAM,MAAM,GAAG,SAAS,GAAG,EAAE,MAAM;YACnC,MAAM,OAAO,IAAI,GAAG,CAAC,QAAQ;gBAAE;gBAAU;gBAAM,KAAK;gBAAG,cAAc;YAAE;YACvE,KAAK,GAAG,IAAI,OAAO,GAAG,QAAQ,IAAI;YAClC,KAAK,YAAY,IAAI,OAAO,GAAG,SAAS,IAAI,KAAK,OAAO,GAAG,QAAQ,IAAI;YACvE,IAAI,GAAG,CAAC,KAAK;QACf;IACF;IAEA,sDAAsD;IACtD,MAAM,QAAQ,IAAI;IAClB,KAAK,MAAM,QAAQ,IAAI,MAAM,GAAI;QAC/B,MAAM,MAAM,KAAK,QAAQ,IAAI;QAC7B,IAAI,CAAC,MAAM,GAAG,CAAC,MAAM,MAAM,GAAG,CAAC,KAAK,EAAE;QACtC,MAAM,GAAG,CAAC,KAAM,IAAI,CAAC;IACvB;IACA,KAAK,MAAM,CAAC,KAAK,IAAI,IAAI,MAAM,OAAO,GAAI;QACxC,IAAI,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,YAAY,GAAG,EAAE,YAAY,IAAI,EAAE,GAAG,GAAG,EAAE,GAAG;QACnE,MAAM,GAAG,CAAC,KAAK,IAAI,KAAK,CAAC,GAAG;IAC9B;IAEA,kFAAkF;IAClF,MAAM,cAA+B,EAAE;IACvC,KAAK,MAAM,OAAO,MAAM,MAAM,GAAI,YAAY,IAAI,IAAI;IAEtD,OAAO,gJAAY,CAAC,IAAI,CAAC;QACvB,MAAM;YAAE;QAAY;QACpB,SAAS;QACT,OAAO;IACT;AACF","debugId":null}}]
}