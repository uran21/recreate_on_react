{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prismaGlobal: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prismaGlobal ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prismaGlobal = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,OAAO,YAAY,IACnB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,OAAO,YAAY,GAAG","debugId":null}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/server/jwt.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"dev_secret_fallback\";\r\n\r\nexport type JwtPayload = { id: number; login: string; role: string };\r\n\r\nexport function signJwt(payload: JwtPayload, days = 7) {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: `${days}d` });\r\n}\r\n\r\nexport function verifyJwt(token: string): JwtPayload | null {\r\n  try { return jwt.verify(token, JWT_SECRET) as JwtPayload; }\r\n  catch { return null; }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAItC,SAAS,QAAQ,OAAmB,EAAE,OAAO,CAAC;IACnD,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW,GAAG,KAAK,CAAC,CAAC;IAAC;AAC/D;AAEO,SAAS,UAAU,KAAa;IACrC,IAAI;QAAE,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAA2B,EAC1D,OAAM;QAAE,OAAO;IAAM;AACvB","debugId":null}},
    {"offset": {"line": 119, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/lib/auth-server.ts"],"sourcesContent":["// src/lib/auth-server.ts\r\nimport { verifyJwt } from \"@/server/jwt\";\r\n\r\nexport type AuthUser = { id: number; login: string; role: string };\r\n\r\nexport class AuthError extends Error {\r\n  status = 401;\r\n  constructor(msg = \"Unauthorized\") { super(msg); }\r\n}\r\n\r\nexport function readBearer(req: Request): string | null {\r\n  const h = req.headers.get(\"authorization\") || \"\";\r\n  if (h.startsWith(\"Bearer \")) return h.slice(7).trim();\r\n  // допускаем токен без префикса (на всякий случай)\r\n  return h ? h.trim() : null;\r\n}\r\n\r\nexport function requireUser(req: Request): AuthUser {\r\n  const token = readBearer(req);\r\n  const payload = token ? verifyJwt(token) : null;\r\n  if (!payload) throw new AuthError();\r\n  return { id: payload.id, login: payload.login, role: payload.role };\r\n}\r\n"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;;;AACzB;;AAIO,MAAM,kBAAkB;IAC7B,SAAS,IAAI;IACb,YAAY,MAAM,cAAc,CAAE;QAAE,KAAK,CAAC;IAAM;AAClD;AAEO,SAAS,WAAW,GAAY;IACrC,MAAM,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,oBAAoB;IAC9C,IAAI,EAAE,UAAU,CAAC,YAAY,OAAO,EAAE,KAAK,CAAC,GAAG,IAAI;IACnD,kDAAkD;IAClD,OAAO,IAAI,EAAE,IAAI,KAAK;AACxB;AAEO,SAAS,YAAY,GAAY;IACtC,MAAM,QAAQ,WAAW;IACzB,MAAM,UAAU,QAAQ,IAAA,mIAAS,EAAC,SAAS;IAC3C,IAAI,CAAC,SAAS,MAAM,IAAI;IACxB,OAAO;QAAE,IAAI,QAAQ,EAAE;QAAE,OAAO,QAAQ,KAAK;QAAE,MAAM,QAAQ,IAAI;IAAC;AACpE","debugId":null}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/app/api/admin/orders/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireUser, AuthError } from \"@/lib/auth-server\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\nfunction startOfDayUTC(d: Date) {\r\n  return new Date(\r\n    Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 0, 0, 0, 0)\r\n  );\r\n}\r\nfunction dayKeyUTC(d: Date): string {\r\n  // YYYY-MM-DD по UTC (удобно и стабильно для сервера)\r\n  return d.toISOString().slice(0, 10);\r\n}\r\n\r\nexport async function GET(req: Request) {\r\n  try {\r\n    const user = requireUser(req);\r\n    if ((user.role || \"\").toLowerCase() !== \"admin\") {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n\r\n    const url = new URL(req.url);\r\n    const days = Math.max(\r\n      1,\r\n      Math.min(10, Number(url.searchParams.get(\"days\")) || 3)\r\n    ); // 1..10\r\n    const cursorRaw = url.searchParams.get(\"cursor\"); // ISO-строка или null\r\n    const cursor = cursorRaw ? new Date(cursorRaw) : new Date();\r\n    if (isNaN(cursor.getTime())) {\r\n      return NextResponse.json({ error: \"Invalid cursor\" }, { status: 400 });\r\n    }\r\n\r\n    // Берём достаточно заказов \"в запас\" (например, 800), чтобы точно набрать 3 дня\r\n    // При необходимости увеличь/уменьши take под свои объёмы.\r\n    const chunk = await prisma.order.findMany({\r\n      where: { createdAt: { lt: cursor } },\r\n      orderBy: { createdAt: \"desc\" },\r\n      take: 800,\r\n      select: {\r\n        id: true,\r\n        status: true,\r\n        totalCents: true,\r\n        createdAt: true,\r\n        customer: {\r\n          select: {\r\n            id: true,\r\n            login: true,\r\n            city: { select: { name: true } },\r\n            street: { select: { name: true } },\r\n            houseNumber: true,\r\n            paymentMethod: true,\r\n          },\r\n        },\r\n        items: {\r\n          select: {\r\n            id: true,\r\n            size: true,\r\n            additivesJson: true,\r\n            quantity: true,\r\n            unitCents: true,\r\n            product: { select: { id: true, name: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Группируем по дате (UTC) и берём не более N разных дат\r\n    type DayBucket = {\r\n      dayIso: string; // YYYY-MM-DD (UTC)\r\n      totalCents: number;\r\n      orders: any[];\r\n    };\r\n    const buckets: Record<string, DayBucket> = {};\r\n    const dayOrder: string[] = [];\r\n\r\n    for (const o of chunk) {\r\n      const k = dayKeyUTC(o.createdAt);\r\n      if (!buckets[k]) {\r\n        if (dayOrder.length >= days) break; // уже набрали нужное кол-во дат\r\n        buckets[k] = { dayIso: k, totalCents: 0, orders: [] };\r\n        dayOrder.push(k);\r\n      }\r\n      buckets[k].orders.push({\r\n        ...o,\r\n        customer: o.customer && {\r\n          id: o.customer.id,\r\n          login: o.customer.login,\r\n          city: o.customer.city?.name ?? null,\r\n          street: o.customer.street?.name ?? null,\r\n          houseNumber: o.customer.houseNumber ?? null,\r\n          paymentMethod: o.customer.paymentMethod ?? null,\r\n        },\r\n      });\r\n      buckets[k].totalCents += o.totalCents;\r\n    }\r\n\r\n    const daysOut = dayOrder.map((k) => buckets[k]);\r\n\r\n    // Сформируем nextBefore: это 00:00 UTC дня, который идёт ПЕРЕД самым старым из выданных\r\n    let nextBefore: string | null = null;\r\n    let hasMore = false;\r\n    if (dayOrder.length > 0) {\r\n      const oldestDayIso = dayOrder[dayOrder.length - 1]; // последний в списке — самый старый день\r\n      const [y, m, d] = oldestDayIso.split(\"-\").map(Number);\r\n      const oldestDayStart = new Date(\r\n        Date.UTC(y, (m as number) - 1, d as number, 0, 0, 0, 0)\r\n      );\r\n      // следующий курсор — начало суток ещё на день раньше\r\n      const prevDayStart = new Date(\r\n        oldestDayStart.getTime() - 24 * 60 * 60 * 1000\r\n      );\r\n      nextBefore = prevDayStart.toISOString();\r\n\r\n      // Проверяем, есть ли ещё заказы раньше prevDayStart\r\n      const more = await prisma.order.findFirst({\r\n        where: { createdAt: { lt: prevDayStart } },\r\n        select: { id: true },\r\n        orderBy: { createdAt: \"desc\" },\r\n      });\r\n      hasMore = !!more;\r\n    }\r\n\r\n    return NextResponse.json({\r\n      data: { days: daysOut, nextBefore, hasMore },\r\n      message: \"OK\",\r\n      error: null,\r\n    });\r\n  } catch (e) {\r\n    if (e instanceof AuthError) {\r\n      return NextResponse.json({ error: e.message }, { status: e.status });\r\n    }\r\n    console.error(\"GET /api/admin/orders error:\", e);\r\n    return NextResponse.json(\r\n      { error: \"Failed to load orders\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}