{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prismaGlobal: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prismaGlobal ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prismaGlobal = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,OAAO,YAAY,IACnB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,OAAO,YAAY,GAAG","debugId":null}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/app/api/products/%5Bid%5D/route.ts"],"sourcesContent":["// src/app/api/products/[id]/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\ntype DbProduct = {\r\n  id: number;\r\n  name: string;\r\n  description: string | null;\r\n  priceCents: number;\r\n  discountPriceCents: number | null;\r\n  category: string;\r\n  image: string | null;\r\n  sizesJson: string | null;\r\n  additivesJson: string | null;\r\n};\r\n\r\ntype DbSize = {\r\n  key: string;\r\n  label: string | null;\r\n  priceCents: number;\r\n  discountPriceCents: number | null;\r\n};\r\n\r\ntype DbAdditive = {\r\n  name: string;\r\n  priceCents: number;\r\n  discountPriceCents: number | null;\r\n};\r\n\r\nexport async function GET(\r\n  req: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } // <-- Next 15 сигнатура\r\n) {\r\n  // 1) Берём id из params (Next 15: Promise), fallback — из URL\r\n  let idStr: string | undefined;\r\n  try {\r\n    const p = await params;\r\n    idStr = p?.id;\r\n  } catch {\r\n    // ignore\r\n  }\r\n  if (!idStr) {\r\n    const m = req.nextUrl.pathname.match(/\\/api\\/products\\/(\\d+)\\/?$/);\r\n    if (m) idStr = m[1];\r\n  }\r\n\r\n  const id = Number(idStr);\r\n  if (!Number.isFinite(id)) {\r\n    return NextResponse.json({ error: \"Invalid ID\" }, { status: 400 });\r\n  }\r\n\r\n  // 2) Продукт (raw без делегатов)\r\n  const prodRows = await prisma.$queryRaw<DbProduct[]>`\r\n    SELECT id, name, description, priceCents, discountPriceCents, category, image, sizesJson, additivesJson\r\n    FROM Product\r\n    WHERE id = ${id}\r\n    LIMIT 1\r\n  `;\r\n  if (!prodRows.length) {\r\n    return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n  }\r\n  const p: DbProduct = prodRows[0];\r\n\r\n  // 3) Sizes: таблица → JSON fallback\r\n  let sizes:\r\n    | Record<\r\n        string,\r\n        { size: string | null; price: string; discountPrice: string | null }\r\n      >\r\n    | null = null;\r\n\r\n  try {\r\n    const sizeRows = await prisma.$queryRaw<DbSize[]>`\r\n      SELECT key, label, priceCents, discountPriceCents\r\n      FROM ProductSize\r\n      WHERE productId = ${id}\r\n      ORDER BY key ASC\r\n    `;\r\n    if (sizeRows.length) {\r\n      sizes = Object.fromEntries(\r\n        sizeRows.map((s) => [\r\n          s.key,\r\n          {\r\n            size: s.label ?? null,\r\n            price: (s.priceCents / 100).toFixed(2),\r\n            discountPrice:\r\n              s.discountPriceCents != null\r\n                ? (s.discountPriceCents / 100).toFixed(2)\r\n                : null,\r\n          },\r\n        ])\r\n      );\r\n    } else if (p.sizesJson) {\r\n      try {\r\n        sizes = JSON.parse(p.sizesJson);\r\n      } catch {\r\n        sizes = null;\r\n      }\r\n    }\r\n  } catch {\r\n    if (p.sizesJson) {\r\n      try {\r\n        sizes = JSON.parse(p.sizesJson);\r\n      } catch {\r\n        sizes = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  // 4) Additives: JOIN → JSON fallback\r\n  let additives: Array<{\r\n    name: string;\r\n    price: string;\r\n    discountPrice: string | null;\r\n  }> = [];\r\n\r\n  try {\r\n    const addRows = await prisma.$queryRaw<DbAdditive[]>`\r\n      SELECT a.name, a.priceCents, a.discountPriceCents\r\n      FROM ProductAdditive pa\r\n      JOIN Additive a ON a.id = pa.additiveId\r\n      WHERE pa.productId = ${id}\r\n      ORDER BY a.id ASC\r\n    `;\r\n    if (addRows.length) {\r\n      additives = addRows.map((a) => ({\r\n        name: a.name,\r\n        price: (a.priceCents / 100).toFixed(2),\r\n        discountPrice:\r\n          a.discountPriceCents != null\r\n            ? (a.discountPriceCents / 100).toFixed(2)\r\n            : null,\r\n      }));\r\n    } else if (p.additivesJson) {\r\n      try {\r\n        additives = JSON.parse(p.additivesJson);\r\n      } catch {\r\n        additives = [];\r\n      }\r\n    }\r\n  } catch {\r\n    if (p.additivesJson) {\r\n      try {\r\n        additives = JSON.parse(p.additivesJson);\r\n      } catch {\r\n        additives = [];\r\n      }\r\n    }\r\n  }\r\n\r\n  // 5) Ответ в «старом» формате\r\n  return NextResponse.json({\r\n    data: {\r\n      id: p.id,\r\n      name: p.name,\r\n      description: p.description ?? \"\",\r\n      price: (p.priceCents / 100).toFixed(2),\r\n      discountPrice:\r\n        p.discountPriceCents != null\r\n          ? (p.discountPriceCents / 100).toFixed(2)\r\n          : null,\r\n      category: p.category,\r\n      image: p.image,\r\n      images: [],\r\n      sizes,\r\n      additives,\r\n    },\r\n    message: \"OK\",\r\n    error: null,\r\n  });\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}