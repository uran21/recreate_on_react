{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prismaGlobal: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prismaGlobal ||\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prismaGlobal = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,OAAO,YAAY,IACnB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,OAAO,YAAY,GAAG","debugId":null}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/server/jwt.ts"],"sourcesContent":["import jwt from \"jsonwebtoken\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"dev_secret_fallback\";\r\n\r\nexport type JwtPayload = { id: number; login: string; role: string };\r\n\r\nexport function signJwt(payload: JwtPayload, days = 7) {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: `${days}d` });\r\n}\r\n\r\nexport function verifyJwt(token: string): JwtPayload | null {\r\n  try { return jwt.verify(token, JWT_SECRET) as JwtPayload; }\r\n  catch { return null; }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAItC,SAAS,QAAQ,OAAmB,EAAE,OAAO,CAAC;IACnD,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW,GAAG,KAAK,CAAC,CAAC;IAAC;AAC/D;AAEO,SAAS,UAAU,KAAa;IACrC,IAAI;QAAE,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAA2B,EAC1D,OAAM;QAAE,OAAO;IAAM;AACvB","debugId":null}},
    {"offset": {"line": 119, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/recreate/recreate_on_react/src/app/api/admin/users/route.ts"],"sourcesContent":["// src/app/api/admin/users/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { verifyJwt } from \"@/server/jwt\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nfunction forbid(msg = \"Forbidden\") {\r\n  return NextResponse.json({ error: msg }, { status: 403 });\r\n}\r\nfunction bad(msg = \"Bad request\", code = 400) {\r\n  return NextResponse.json({ error: msg }, { status: code });\r\n}\r\n\r\n// DTO наружу\r\ntype UserDTO = {\r\n  id: number;\r\n  login: string;\r\n  role: string;\r\n  city: string | null;\r\n  street: string | null;\r\n  houseNumber: number | null;\r\n  paymentMethod: string | null;\r\n  createdAt: string | null;\r\n};\r\n\r\nexport async function GET(req: Request) {\r\n  const auth = req.headers.get(\"authorization\") || \"\";\r\n  const token = auth.startsWith(\"Bearer \") ? auth.slice(7) : \"\";\r\n  const payload = token ? (verifyJwt(token) as { role?: string } | null) : null;\r\n  if (!payload || (payload.role || \"\").toLowerCase() !== \"admin\") {\r\n    return forbid();\r\n  }\r\n\r\n  const users = await prisma.user.findMany({\r\n    orderBy: { id: \"desc\" },\r\n    include: { city: true, street: true },\r\n  });\r\n\r\n  type UserWithRefs = typeof users[number]; // ← тип одного элемента массива\r\n\r\n  const out: UserDTO[] = users.map((u: UserWithRefs) => ({\r\n    id: u.id,\r\n    login: u.login,\r\n    role: u.role,\r\n    city: u.city?.name ?? null,\r\n    street: u.street?.name ?? null,\r\n    houseNumber: u.houseNumber ?? null,\r\n    paymentMethod: u.paymentMethod ?? null,\r\n    createdAt: u.createdAt?.toISOString?.() ?? null,\r\n  }));\r\n\r\n  return NextResponse.json({\r\n    data: { users: out },\r\n    message: \"OK\",\r\n    error: null,\r\n  });\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  const auth = req.headers.get(\"authorization\") || \"\";\r\n  const token = auth.startsWith(\"Bearer \") ? auth.slice(7) : \"\";\r\n  const payload = token ? (verifyJwt(token) as { role?: string } | null) : null;\r\n  if (!payload || (payload.role || \"\").toLowerCase() !== \"admin\") {\r\n    return forbid();\r\n  }\r\n\r\n  const body = await req.json().catch(() => ({} as Record<string, unknown>));\r\n  const { login, password, role = \"user\", paymentMethod = \"card\" } = body as {\r\n    login: string;\r\n    password: string;\r\n    role?: string;\r\n    paymentMethod?: string;\r\n  };\r\n\r\n  const reLogin = /^[A-Za-z][A-Za-z0-9]{2,}$/;\r\n  const rePassword = /^(?=.*[^\\w\\s]).{6,}$/;\r\n  if (!reLogin.test(String(login || \"\"))) return bad(\"Invalid login\");\r\n  if (!rePassword.test(String(password || \"\"))) return bad(\"Invalid password\");\r\n\r\n  try {\r\n    const hash = await bcrypt.hash(password, 10);\r\n    const created = await prisma.user.create({\r\n      data: {\r\n        login: String(login),\r\n        passwordHash: hash,\r\n        role: String(role || \"user\"),\r\n        paymentMethod: String(paymentMethod || \"card\"),\r\n      },\r\n      include: { city: true, street: true },\r\n    });\r\n\r\n    const user: UserDTO = {\r\n      id: created.id,\r\n      login: created.login,\r\n      role: created.role,\r\n      city: created.city?.name ?? null,\r\n      street: created.street?.name ?? null,\r\n      houseNumber: created.houseNumber ?? null,\r\n      paymentMethod: created.paymentMethod ?? null,\r\n      createdAt: created.createdAt?.toISOString?.() ?? null,\r\n    };\r\n\r\n    return NextResponse.json(\r\n      { data: { user }, message: \"Created\", error: null },\r\n      { status: 201 }\r\n    );\r\n  } catch (err) {\r\n    const msg = err instanceof Error ? err.message : String(err);\r\n    if (/unique/i.test(msg)) {\r\n      return NextResponse.json(\r\n        { error: \"Login already exists\" },\r\n        { status: 409 }\r\n      );\r\n    }\r\n    return NextResponse.json({ error: \"Failed to create\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}